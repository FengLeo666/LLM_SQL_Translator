<!doctype html>
<html lang="zh-CN">
<head>
    <meta charset="utf-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1"/>
    <title>SQL 分片转换器</title>
    <link rel="stylesheet" href="./static/index.css">
</head>

<body>
<header>
    <div class="wrap">
        <div class="titlebar">
            <div>
                <h1>SQL 分片转换器</h1>
                <div class="sub">
                    先填写参数（所有请求共享）→ 拖拽 SQL 自动分片 → 录入特殊需求生成 Prompt → 全部 chunk 成功后导出。
                </div>
            </div>
            <div class="pillrow">
                <div class="pill">会话：<b id="sessionPill">-</b></div>
                <div class="pill">分片数：<b id="chunksPill">0</b></div>
                <div class="pill">参数已确认：<b id="paramsPill">否</b></div>
                <div class="pill">Prompt 已生成：<b id="promptPill">否</b></div>
            </div>
        </div>
    </div>
</header>

<main>
    <!--    <img src="/static/main_pic.png" alt="">-->
    <div class="wrap">
        <div class="grid">

            <!-- Left: params + files -->
            <div class="card">
                <div class="hd">
                    <h2>1) 参数（所有请求共享）与文件</h2>
                    <div class="inlineNote">
                        <span id="fileInfo">未上传 SQL 文件</span>
                        <!--                        <span class="hint">· 并发固定 <b>188</b> · 每个 Chunk 最大重试 <b>3</b> 次</span>-->
                    </div>
                </div>
                <div class="bd" id="sectionParams">

                    <div class="paramGrid">
                        <div class="field">
                            <label>源 SQL 类型（source_format，必填）</label>
                            <input id="sourceFormat" type="text" value="" list="sqlDialectsList"
                                   placeholder="选择或输入，例如 gbase8c / mysql / hive"/>
                        </div>
                        <div class="field">
                            <label>目标规范类型（destination_format，必填）</label>
                            <input id="destFormat" type="text" value="" list="warehouseSpecsList"
                                   placeholder="选择或输入，例如 gbasehd / gbase_hd_spec / hive_warehouse_spec"/>
                        </div>
                        <div class="field">
                            <label>目标数据库方言（destination_sql_language，可选）</label>
                            <input id="destLang" type="text" value="" list="sqlDialectsList"
                                   placeholder="选择或输入，例如 hive / doris / mysql（留空由后端按 destination_format 推导）"/>
                        </div>
                        <div class="field">
                            <label>目标 Schema（target_schema，可选）</label>
                            <input id="targetSchema" type="text" value="" placeholder="可留空，例如 stg_xxx"/>
                        </div>
                        <div class="field">
                            <label>合并表数量 n（默认 1，过长的上下文不稳定会导致自动重试）</label>
                            <input id="mergeN" type="number" min="1" step="1" value="1" placeholder="1"/>
                        </div>

                        <div class="field">
                            <label>并发数（concurrency，默认 188）</label>
                            <input id="concurrency" type="number" min="1" step="1" value="188" placeholder="188"/>
                        </div>
                    </div>

                    <!-- 下拉建议数据源（可输入、可选择） -->
                    <datalist id="warehouseSpecsList">
                        <option value="gbasehd"></option>
                        <option value="ods"></option>
                        <option value="stg"></option>
                        <option value="dwd"></option>
                        <option value="dws"></option>
                        <option value="dm"></option>
                        <option value="ads"></option>
                        <option value="hd"></option>
                        <option value="hive_warehouse_spec"></option>
                        <option value="spark_warehouse_spec"></option>
                        <option value="gbase_hd_spec"></option>
                        <option value="greenplum_warehouse_spec"></option>
                        <option value="doris_warehouse_spec"></option>
                        <option value="starrocks_warehouse_spec"></option>
                        <option value="clickhouse_warehouse_spec"></option>
                        <option value="maxcompute_warehouse_spec"></option>
                        <option value="custom_warehouse_spec"></option>
                    </datalist>

                    <datalist id="sqlDialectsList">
                        <option value="mysql"></option>
                        <option value="mariadb"></option>
                        <option value="postgresql"></option>
                        <option value="oracle"></option>
                        <option value="sqlserver"></option>
                        <option value="db2"></option>
                        <option value="sqlite"></option>
                        <option value="hive"></option>
                        <option value="spark_sql"></option>
                        <option value="presto"></option>
                        <option value="trino"></option>
                        <option value="clickhouse"></option>
                        <option value="doris"></option>
                        <option value="starrocks"></option>
                        <option value="greenplum"></option>
                        <option value="teradata"></option>
                        <option value="vertica"></option>
                        <option value="snowflake"></option>
                        <option value="redshift"></option>
                        <option value="bigquery"></option>
                        <option value="maxcompute"></option>
                        <option value="gbase8c"></option>
                        <option value="gbase8a"></option>
                        <option value="gbase_hd"></option>
                        <option value="gaussdb_dws"></option>
                        <option value="opengauss"></option>
                        <option value="kingbase"></option>
                        <option value="dm"></option>
                        <option value="oceanbase_mysql"></option>
                        <option value="oceanbase_oracle"></option>
                    </datalist>

                    <div class="sep"></div>

                    <div id="sqlDrop" class="drop">
                        <div class="left">
                            <div class="big">
                                <span id="sqlDropTitle">拖拽 SQL 文件到这里（自动分片）</span>
                                <span id="sqlDropTag" class="tag hidden"><span class="dot"></span>已上传</span>
                            </div>
                            <div class="small" id="sqlDropSub">或点击右侧按钮选择文件（内容仅保存在浏览器内存中）</div>
                        </div>
                        <div class="right">
                            <button id="pickSqlBtn" class="primary">选择 SQL 文件</button>
                            <input id="sqlFile" type="file" accept=".sql,.txt" class="hidden"/>
                        </div>
                    </div>

                    <div class="sep"></div>

                    <div id="tplDrop" class="drop">
                        <div class="left">
                            <div class="big">
                                <span id="tplDropTitle">可选：上传参考模版（destination_example）</span>
                                <span id="tplDropTag" class="tag hidden"><span class="dot"></span>已上传</span>
                            </div>
                            <div class="small" id="tplDropSub">用于生成 Prompt（normalize_prompt 的
                                destination_example）
                            </div>
                        </div>
                        <div class="right">
                            <button id="pickTplBtn">选择模版文件</button>
                            <input id="tplFile" type="file" accept=".sql,.txt,.md,.text" class="hidden"/>
                        </div>
                    </div>

                    <!--                    <div class="hint" style="margin-top:10px;">-->
                    <!--                        分片规则：大小写不敏感查找 <span class="mono">CREATE TABLE</span>；对每个 CREATE TABLE，找到其左侧最近的-->
                    <!--                        <span class="mono">;</span>，以其后位置作为切分边界；若找不到 CREATE TABLE，则视为单 chunk。-->
                    <!--                    </div>-->

                    <div class="btnrow" style="margin-top:12px;">
                        <button id="btnConfirmParams" class="good">确认参数</button>
                        <button id="btnEditParams" class="danger" disabled>修改参数</button>
                        <span class="hint" id="paramsStatus">未确认：请填写必要参数后点击“确认参数”。</span>
                    </div>

                    <div class="hint" style="margin-top:10px; color: rgba(239,68,68,.95);" id="paramError"></div>
                </div>
            </div>

            <!-- Right: special needs + generated prompt -->
            <div class="card" id="promptCard">
                <div class="hd">
                    <h2>2) Prompt 生成</h2>
                    <div class="inlineNote">
                        <span class="badge wait" id="promptBadge">
                            <span id="promptBadgeIcon" class="dot"></span>
                            <span id="promptInfo">未生成</span>
                        </span>
                    </div>
                </div>

                <div class="bd" id="sectionPrompt">
                    <label>用户 Prompt（可编辑；您可在此处填写您的特殊需求；点击生成后交由后端归一化为最终
                        general_prompt）</label>
                    <textarea id="specialNeeds" class="mono"></textarea>

                    <div class="btnrow">
                        <button id="btnGeneratePrompt" class="primary" disabled>生成 General Prompt（后端）</button>

                        <label class="switchWrap" title="开启后：general_prompt 生成成功会自动执行 Convert All">
                            <input id="autoConvertToggle" type="checkbox"/>
                            <span class="switch"></span>
                            <span class="switchText">自动 Convert</span>
                        </label>

                        <span class="hint" id="promptStatus">提示：生成时会传入 destination_example（如已上传模版）与 target_schema 等参数。</span>
                    </div>

                    <div id="promptBanner" class="promptBanner">
                        <div class="left">
                            <span id="promptBannerIcon" class="dot"></span>
                            <div>
                                <div class="title" id="promptBannerTitle">-</div>
                                <div class="hint" id="promptBannerSub"></div>
                            </div>
                        </div>
                        <div class="hint mono" id="promptBannerMeta"></div>
                    </div>

                    <div class="sep"></div>

                    <label>生成后的 general_prompt（用于遍历下列所有分片；只读；如需修改，请修改上方“用户
                        Prompt”后重新生成）</label>
                    <textarea id="generatedPrompt" class="mono" readonly style="min-height: 160px;"></textarea>

                    <!--                    <div class="sep"></div>-->

                    <!--                    <label class="mono">destination_example 预览（前 1200 字符）</label>-->
                    <!--                    <textarea id="tplPreview" readonly class="mono" style="min-height: 100px;" placeholder="未上传模版"></textarea>-->
                </div>
            </div>

        </div>

        <!-- Chunk list -->
        <div class="card lockWrap" id="sectionChunks" style="margin-top:14px;">
            <!--            <div id="chunksLock" class="lockLayer">-->
            <!--                <div class="box">-->
            <!--                    <div class="t" id="chunksLockTitle">Chunk 区域已冻结</div>-->
            <!--                    <div class="m" id="chunksLockMsg">请先在右侧生成 General Prompt；生成完成后将自动解锁。</div>-->
            <!--                </div>-->
            <!--            </div>-->

            <div class="chunksTop">
                <div class="progress">
                    <span class="badge wait"><span class="dot"></span>等待：<b id="cntWait">0</b></span>
                    <span class="badge run"><span class="dot"></span>执行中：<b id="cntRun">0</b></span>
                    <span class="badge ok"><span class="dot"></span>成功：<b id="cntOk">0</b></span>
                    <span class="badge err"><span class="dot"></span>失败：<b id="cntErr">0</b></span>
                    <span class="pill">可导出：<b id="exportReady">否</b></span>
                </div>

                <div class="btnrow" style="margin:0;">
                    <span id="runInfo" class="hint"></span>
                    <button id="btnConvertAll" class="primary" disabled>Convert All</button>
                    <button id="btnRedoFailed" disabled>一键重做失败 Chunk</button>
                    <button id="btnExport" class="good" disabled>导出 SQL</button>
                </div>
            </div>

            <div id="chunksContainer" style="padding-bottom:10px;"></div>
        </div>

    </div>
</main>

<script src="./static/index.js"></script>

</body>
</html>
